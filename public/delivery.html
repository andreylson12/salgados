<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Salgados da Rayleniza â€“ Delivery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="/manifest.json?v=9">
  <meta name="theme-color" content="#0b0f1a">

  <style>
    :root{
      --bg:#0b0f1a; --panel:#0f172a; --text:#e2e8f0; --muted:#94a3b8;
      --brand:#ea580c; --blue:#3b82f6; --radius:14px; --shadow:0 10px 26px rgba(0,0,0,.25);
    }
    body{margin:0;background:linear-gradient(160deg,#0b0f1a 0%,#0f172a 60%,#111827 100%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{background:linear-gradient(180deg,#0f172a 0%,#0b0f1a 100%);padding:16px 14px;text-align:center;position:sticky;top:0;z-index:5;border-bottom:1px solid #0b1220}
    header h1{margin:0;font-size:18px} header p{margin:4px 0 0;color:var(--muted);font-size:13px}
    main{padding:14px}
    .produtos{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .card{background:linear-gradient(180deg,#0b1220 0%,#0f172a 100%);border:1px solid #0b1220;border-radius:var(--radius);padding:10px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:8px;min-height:260px}
    .img-wrap{width:100%;aspect-ratio:4/3;background:#0b1220;border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .img-wrap img{max-width:100%;max-height:100%;object-fit:contain;display:block;border-radius:8px}
    .card h3{margin:0;font-size:15px;line-height:1.2;min-height:2.4em;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .card .price{font-weight:700;color:#ffedd5}
    .stock{font-size:12px;color:var(--muted)}
    .btn{background:linear-gradient(180deg,var(--brand) 0%,#c2410c 100%);color:#fff;border:none;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn:hover{filter:brightness(.98)} .btn[disabled]{opacity:.5;cursor:not-allowed}
    #carrinho,#pagamento{background:linear-gradient(180deg,#0b1220 0%,#0f172a 100%);border:1px solid #0b1220;color:var(--text);padding:14px;border-radius:var(--radius);margin:16px 0;box-shadow:var(--shadow)}
    #pagamento{text-align:center;display:none}
    #pixQr{width:220px;height:220px;margin:10px auto;background:#fff;border-radius:12px;padding:6px}
    .btn-finalizar{width:100%;padding:12px;background:linear-gradient(180deg,var(--blue),#2563eb);color:#fff;border:none;border-radius:12px;font-size:16px;cursor:pointer}
    .btn-finalizar[disabled]{opacity:.65;cursor:not-allowed}
    .muted{color:var(--muted);font-size:13px;margin-top:6px}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
</head>
<body>
  <header>
    <h1>Salgados da Rayleniza</h1>
    <p>Escolha seus salgados e faÃ§a seu pedido</p>
  </header>

  <main>
    <section class="produtos" id="listaProdutos"></section>

    <section id="carrinho">
      <h2>ðŸ›’ Seu Carrinho</h2>
      <table>
        <thead><tr><th>Produto</th><th>Qtd</th><th>PreÃ§o</th><th>Total</th></tr></thead>
        <tbody id="itensCarrinho"></tbody>
      </table>
      <h3 id="totalCarrinho">Total: R$ 0,00</h3>

      <input id="clienteNome" placeholder="Seu Nome" required />
      <input id="clienteEndereco" placeholder="EndereÃ§o de entrega" required />
      <select id="clientePagamento">
        <option value="PIX">PIX</option>
        <option>Dinheiro</option>
        <option>CartÃ£o</option>
      </select>

      <button id="btnFinalizar" class="btn-finalizar" onclick="finalizarPedido()">Finalizar Pedido</button>
    </section>

    <section id="pagamento">
      <h2>ðŸ’³ Pagamento via PIX</h2>
      <div id="pixQr"></div>
      <p id="pixTimer" class="muted"></p>
      <p>Chave PIX (Telefone): <strong id="pixChave"></strong></p>
      <p class="muted">Nome: <span id="pixNome"></span> â€” Cidade: <span id="pixCidade"></span></p>
      <div class="row-btns">
        <button id="btnCopiarChave" class="btn" onclick="copiarChave()">ðŸ“‹ Copiar chave PIX</button>
        <button id="btnCopiarPayload" class="btn" onclick="copiarPayload()">ðŸ“‹ Copiar cÃ³digo PIX</button>
        <button id="btnCopiarValor" class="btn" onclick="copiarValor()">ðŸ“‹ Copiar valor</button>
      </div>
      <p id="msgCopiado" style="display:none;color:#22c55e">âœ… Copiado!</p>
    </section>
  </main>

  <script>
    // Estado global
    let carrinho = [];
    let chavePix = "";     // vem do servidor
    let nomeLoja = "";
    let cidade = "";
    let _payload = "";
    let _valor = 0;

    const moeda = n => Number(n).toFixed(2).replace('.', ',');

    // ---------- Carregar dados PIX do servidor ----------
    async function carregarChavePix(){
      try{
        const r = await fetch("/api/chave-pix", {cache:"no-store"});
        const d = await r.json();
        chavePix = String(d.chave || "").replace(/\s+/g,""); // tira espaÃ§os
        nomeLoja = d.nome || "";
        cidade = d.cidade || "";

        // exibiÃ§Ã£o amigÃ¡vel se for telefone 55 + DDD + nÃºmero
        document.getElementById("pixChave").textContent =
          (chavePix.startsWith("55") && (chavePix.length===13 || chavePix.length===14))
          ? `(${chavePix.slice(2,4)}) ${chavePix.slice(4,9)}-${chavePix.slice(9)}`
          : chavePix;

        document.getElementById("pixNome").textContent = nomeLoja;
        document.getElementById("pixCidade").textContent = cidade;
      }catch(e){ console.error("Erro ao obter chave PIX:", e); }
    }

    // ---------- Produtos ----------
    async function carregarProdutos(){
      const r = await fetch("/api/produtos", {cache:"no-store"});
      const produtos = await r.json();
      const el = document.getElementById("listaProdutos");
      el.innerHTML = "";
      produtos.filter(p=>Number(p.estoque)>0).forEach(p=>{
        const img = p.imagem || "https://via.placeholder.com/600x600?text=Salgado";
        el.innerHTML += `
          <div class="card">
            <div class="img-wrap"><img src="${img}" alt="${p.nome}" loading="lazy"></div>
            <h3>${p.nome}</h3>
            <div class="price">R$ ${moeda(p.preco)}</div>
            <div class="stock">Estoque: ${p.estoque}</div>
            <button class="btn" onclick="adicionar(${p.id},'${p.nome.replace(/'/g,'&#39;')}',${Number(p.preco)})">Adicionar</button>
          </div>`;
      });
    }

    function adicionar(id,nome,preco){
      const item = carrinho.find(i=>i.id===id);
      if(item) item.quantidade++; else carrinho.push({id,nome,preco,quantidade:1});
      render();
    }

    function render(){
      const tb = document.getElementById("itensCarrinho");
      tb.innerHTML = "";
      let total = 0;
      carrinho.forEach(i=>{
        const sub = i.preco*i.quantidade; total += sub;
        tb.innerHTML += `<tr><td>${i.nome}</td><td>${i.quantidade}</td><td>R$ ${moeda(i.preco)}</td><td>R$ ${moeda(sub)}</td></tr>`;
      });
      document.getElementById("totalCarrinho").textContent = "Total: R$ "+moeda(total);
    }

    // ---------- Finalizar (usa PIX do servidor) ----------
    async function finalizarPedido(){
      if(!carrinho.length) return alert("Carrinho vazio!");
      const nome = document.getElementById("clienteNome").value.trim();
      const endereco = document.getElementById("clienteEndereco").value.trim();
      const pagamento = document.getElementById("clientePagamento").value;
      if(!nome||!endereco) return alert("Preencha seu nome e endereÃ§o.");

      const total = carrinho.reduce((s,i)=>s+i.preco*i.quantidade,0);
      _valor = Number(total.toFixed(2));

      const pedido = { cliente:{nome,endereco}, itens:carrinho, total:_valor, pagamento };

      const res = await fetch("/api/pedidos", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(pedido)
      });
      const salvo = await res.json();

      if (pagamento === "PIX" && salvo?.pix?.payload){
        const sec = document.getElementById("pagamento");
        sec.style.display = "block";

        const qrEl = document.getElementById("pixQr");
        qrEl.innerHTML = "";
        new QRCode(qrEl, { text: salvo.pix.payload, width: 220, height: 220 });

        _payload = salvo.pix.payload;

        // timer simples (visual)
        const t0 = Date.now(), ms = 10*60*1000;
        const label = document.getElementById("pixTimer");
        const id = setInterval(()=>{
          const rest = ms - (Date.now()-t0);
          if(rest<=0){ clearInterval(id); label.textContent = "QR expirado"; return; }
          const s = Math.floor(rest/1000); const mm = String(Math.floor(s/60)).padStart(2,"0"); const ss = String(s%60).padStart(2,"0");
          label.textContent = `Expira em ${mm}:${ss}`;
        },1000);
      } else {
        document.getElementById("pagamento").style.display="none";
      }

      carrinho = []; render();
    }

    // ---------- Copiar ----------
    function copiarChave(){ navigator.clipboard.writeText(chavePix); ok(); }
    function copiarPayload(){ if(_payload) navigator.clipboard.writeText(_payload).then(ok); }
    function copiarValor(){ navigator.clipboard.writeText("R$ "+moeda(_valor)).then(ok); }
    function ok(){ const e=document.getElementById("msgCopiado"); e.style.display="block"; setTimeout(()=>e.style.display="none",2000); }

    // ---------- Boot ----------
    document.addEventListener("DOMContentLoaded", ()=>{ carregarChavePix(); carregarProdutos(); });
  </script>
</body>
</html>
