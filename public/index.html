<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel - Salgados da Rayleniza</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#0b1020" />
  <style>
    body { margin:0; font-family:Arial, sans-serif; display:flex; height:100vh; background:#0b1020; color:#e5ecff; }
    .sidebar{ width:230px; background:#0d1328; padding:18px; border-right:1px solid #192347; }
    .sidebar h2{ margin:0 0 10px; font-size:18px; color:#8ab4ff }
    .sidebar a{ display:block; margin:10px 0; padding:10px; border-radius:8px; text-decoration:none; color:#e5ecff; background:#11183a }
    .sidebar a:hover{ background:#1a2354 }
    .content{ flex:1; padding:20px; overflow-y:auto; }
    h1{ margin-top:0 }
    section{ display:none; }
    section.active{ display:block; }
    table{ border-collapse:collapse; width:100%; background:#121a39; }
    th, td{ padding:10px; border:1px solid #1e2a5c; vertical-align: top; text-align:center; }
    input, button, select{ padding:10px; margin:6px 0; border-radius:8px; border:none; }
    input[type="number"]{ width:120px; }
    input[type="url"], input[type="text"]{ width:100%; max-width:380px; }
    button{ background:#3569ff; color:#fff; cursor:pointer; }
    button:hover{ filter:brightness(1.1) }
    .btn-remover{ background:#e74c3c; }
    .btn-editar{ background:#2d9bdb; }
    .btn-cancelar{ background:#7f8c8d; }
    .btn-salvar{ background:#2ecc71; }
    .acao-grid{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    .total-row td{font-weight:700;background:#0f1736;color:#fff}
    tr.editing{ background:#16204a; }
    .helper{ color:#a0b0ff; font-size:12px; margin-top:2px; word-break:break-all; }
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#192347;color:#8ab4ff;font-size:12px}
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Salgados da Rayleniza</h2>
    <a onclick="mostrarSecao('produtos')">üè∑Ô∏è Produtos</a>
    <a onclick="mostrarSecao('pedidos')">üöö Pedidos</a>
  </div>

  <div class="content">
    <h1>Gest√£o de pedidos e card√°pio</h1>
    <p class="pill">Dica: voc√™ pode editar produtos direto na tabela com ‚ÄúEditar‚Äù.</p>

    <section id="produtos" class="active">
      <h2>üè∑Ô∏è Produtos</h2>
      <form id="formProdutos">
        <input id="nomeProduto" placeholder="Nome do salgado" required />
        <input id="precoProduto" type="number" step="0.01" placeholder="Pre√ßo" required />
        <input id="estoqueProduto" type="number" placeholder="Estoque" required />
        <input id="imagemProduto" placeholder="URL da imagem (opcional)" />
        <button type="submit">Adicionar</button>
      </form>
      <table>
        <thead>
          <tr>
            <th>NOME</th><th>PRE√áO</th><th>ESTOQUE</th><th>IMAGEM (URL)</th><th>A√á√ïES</th>
          </tr>
        </thead>
        <tbody id="listaProdutos"></tbody>
      </table>
    </section>

    <section id="pedidos">
      <h2>üöö Pedidos</h2>
      <table>
        <thead>
          <tr>
            <th>ID</th><th>CLIENTE</th><th>ENDERE√áO</th><th>ITENS</th>
            <th>TOTAL</th><th>PAGAMENTO</th><th>STATUS</th><th>A√á√ïES</th>
          </tr>
        </thead>
        <tbody id="listaPedidos"></tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="4" style="text-align:right">Total geral:</td>
            <td id="tdTotalGeral">R$ 0,00</td>
            <td colspan="3"></td>
          </tr>
        </tfoot>
      </table>
    </section>
  </div>

  <audio id="alertSound" preload="auto"></audio>

  <script>
    const API = { produtos: "/api/produtos", pedidos: "/api/pedidos" };
    const moeda = n => Number(n).toFixed(2).replace('.', ',');

    function mostrarSecao(id){
      document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    /* ---------------- Auth de rotas admin via header ---------------- */
    // use o mesmo token que est√° em process.env.DEBUG_TOKEN no Railway
    const ADMIN_TOKEN = "segredo123";

    function afetch(url, opts = {}) {
      const headers = new Headers(opts.headers || {});
      headers.set("X-Admin-Token", ADMIN_TOKEN);
      if (!headers.has("Content-Type") && opts.body) {
        headers.set("Content-Type", "application/json");
      }
      return fetch(url, { ...opts, headers, credentials: "include" });
    }

    /* ---------------- Service Worker opcional ---------------- */
    let swReg = null;
    async function registrarServiceWorker() {
      if ("serviceWorker" in navigator) {
        try {
          swReg = await navigator.serviceWorker.register("/service-worker.js");
          console.log("[SW] registrado", swReg);
        } catch (e) {
          console.warn("[SW] falhou:", e);
        }
      }
    }

    /* ---------------- Produtos (edi√ß√£o inline) ---------------- */
    const estadoEdicao = new Map();

    async function carregarProdutos(){
      const res = await fetch(API.produtos, { cache:"no-store" });
      if (!res.ok) { alert("Falha ao carregar produtos"); return; }
      const produtos = await res.json();
      const tbody = document.getElementById("listaProdutos");
      tbody.innerHTML = "";
      produtos.forEach(p=>{
        const tr = document.createElement("tr");
        const id = String(p.id);
        tr.dataset.id = id;
        tr.innerHTML = renderLinhaProdutoView({ ...p, id });
        tbody.appendChild(tr);
      });
    }

    function renderLinhaProdutoView(p){
      const img = p.imagem || "https://via.placeholder.com/300x300?text=Produto";
      const idAttr = escapeAttr(String(p.id));
      return `
        <td title="${escapeAttr(p.nome)}">${escapeHtml(p.nome)}</td>
        <td>R$ ${moeda(p.preco)}</td>
        <td>${Number(p.estoque)}</td>
        <td><div class="helper">${escapeHtml(img)}</div></td>
        <td>
          <div class="acao-grid">
            <button class="btn-editar" onclick="editarProduto('${idAttr}')">Editar</button>
            <button class="btn-remover" onclick="removerProduto('${idAttr}')">Excluir</button>
          </div>
        </td>
      `;
    }

    function renderLinhaProdutoEdit(p){
      const id = String(p.id);
      const valores = estadoEdicao.get(id) || { nome:p.nome, preco:p.preco, estoque:p.estoque, imagem:p.imagem || "" };
      const idAttr = escapeAttr(id);
      return `
        <td><input type="text" id="edit-nome-${idAttr}" value="${escapeAttr(valores.nome)}" placeholder="Nome" /></td>
        <td><input type="number" id="edit-preco-${idAttr}" value="${Number(valores.preco)}" step="0.01" min="0" placeholder="Pre√ßo" /></td>
        <td><input type="number" id="edit-estoque-${idAttr}" value="${parseInt(valores.estoque||0)}" min="0" placeholder="Estoque" /></td>
        <td>
          <input type="url" id="edit-imagem-${idAttr}" value="${escapeAttr(valores.imagem || "")}" placeholder="URL da imagem" />
          <div class="helper">Dica: deixe vazio para manter a atual.</div>
        </td>
        <td>
          <div class="acao-grid">
            <button class="btn-salvar" onclick="salvarProduto()">Salvar</button>
            <button class="btn-cancelar" onclick="cancelarEdicao('${idAttr}')">Cancelar</button>
          </div>
        </td>
      `;
    }

    function editarProduto(id){
      id = String(id);
      const tr = document.querySelector(`tr[data-id="${CSS.escape(id)}"]`);
      if (!tr || tr.classList.contains("editing")) return;

      const tds = tr.querySelectorAll("td");
      const atual = {
        nome: tds[0].innerText.trim(),
        preco: parseFloat((tds[1].innerText || "0").replace(/[^\d,.-]/g,"").replace(".","").replace(",", ".")) || 0,
        estoque: parseInt(tds[2].innerText) || 0,
        imagem: (tds[3].querySelector(".helper")?.textContent || "").trim()
      };
      estadoEdicao.set(id, { ...atual, original: atual });

      tr.classList.add("editing");
      tr.innerHTML = renderLinhaProdutoEdit({ id, ...atual });

      tr.querySelectorAll("input").forEach(inp=>{
        inp.addEventListener("keydown", (e)=>{
          if (e.key === "Enter") salvarProduto();
          if (e.key === "Escape") cancelarEdicao(id);
        });
      });
      tr.querySelector(`#edit-nome-${CSS.escape(id)}`)?.focus();
    }

    function cancelarEdicao(id){
      id = String(id);
      const tr = document.querySelector(`tr[data-id="${CSS.escape(id)}"]`);
      if (!tr) return;
      const st = estadoEdicao.get(id);
      const p = st?.original ? { id, ...st.original } : { id, nome: "-", preco: 0, estoque: 0, imagem: "" };
      tr.classList.remove("editing");
      tr.innerHTML = renderLinhaProdutoView(p);
      estadoEdicao.delete(id);
    }

    async function salvarProduto(){
      const tr = document.querySelector("tr.editing");
      if (!tr) return;
      const id = String(tr.dataset.id);

      const nome    = (document.getElementById(`edit-nome-${id}`)?.value || "").trim();
      const preco   = parseFloat(document.getElementById(`edit-preco-${id}`)?.value || "0");
      const estoque = parseInt(document.getElementById(`edit-estoque-${id}`)?.value || "0");
      const imagem  = (document.getElementById(`edit-imagem-${id}`)?.value || "").trim();

      if (!nome) return alert("Informe o nome.");
      if (Number.isNaN(preco) || preco < 0) return alert("Pre√ßo inv√°lido.");
      if (!Number.isInteger(estoque) || estoque < 0) return alert("Estoque inv√°lido.");

      const payload = { nome, preco, estoque };
      if (imagem) payload.imagem = imagem;

      try{
        let res = await afetch(`${API.produtos}/${encodeURIComponent(id)}`, {
          method:"PATCH",
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          res = await afetch(`${API.produtos}/${encodeURIComponent(id)}`, {
            method:"PUT",
            body: JSON.stringify(payload)
          });
        }
        if (!res.ok) {
          const txt = await res.text().catch(()=> "");
          throw new Error(`Falha ao atualizar (HTTP ${res.status}) ${txt}`);
        }
        await carregarProdutos();
      }catch(e){
        console.error(e);
        alert("Erro ao salvar. Veja o console.");
      }finally{
        estadoEdicao.delete(id);
      }
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[s]));
    }
    function escapeAttr(str){ return escapeHtml(str).replace(/"/g, "&quot;"); }

    async function removerProduto(id){
      id = String(id);
      if(confirm("Excluir?")){
        await afetch(`${API.produtos}/${encodeURIComponent(id)}`, { method:"DELETE" });
        carregarProdutos();
      }
    }

    // Cria√ß√£o de produto (POST)
    document.getElementById("formProdutos").addEventListener("submit", async e=>{
      e.preventDefault();
      const novo = {
        nome: document.getElementById("nomeProduto").value.trim(),
        preco: parseFloat(document.getElementById("precoProduto").value),
        estoque: parseInt(document.getElementById("estoqueProduto").value),
        imagem: document.getElementById("imagemProduto").value || "https://via.placeholder.com/300x300?text=Produto"
      };
      if (!novo.nome) return alert("Informe o nome.");
      if (Number.isNaN(novo.preco) || novo.preco < 0) return alert("Pre√ßo inv√°lido.");
      if (!Number.isInteger(novo.estoque) || novo.estoque < 0) return alert("Estoque inv√°lido.");

      const res = await afetch(API.produtos, {
        method:"POST",
        body: JSON.stringify(novo)
      });
      if (!res.ok) {
        const t = await res.text().catch(()=> "");
        alert("Falha ao criar produto: " + t);
        return;
      }
      e.target.reset();
      carregarProdutos();
    });

    /* ---------------- Pedidos ---------------- */
    function atualizarAutoSoma(pedidos){
      const total = (Array.isArray(pedidos) ? pedidos : [])
        .reduce((s, p) => s + Number(p.total || 0), 0);
      const td = document.getElementById('tdTotalGeral');
      if (td) td.textContent = 'R$ ' + moeda(total);
    }

    let pedidosConhecidos = new Set();
    async function carregarPedidos(){
      const res = await afetch(API.pedidos, { cache:"no-store" });
      if (!res.ok) return; 
      const pedidos = await res.json();
      const tbody = document.getElementById("listaPedidos");
      tbody.innerHTML = "";

      pedidos.forEach(p=>{
        const id = String(p.id);
        const itens = (p.itens||[]).map(i => `${i.nome} x${i.quantidade}`).join(", ");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(id)}</td>
          <td>${escapeHtml(p.cliente?.nome||"-")}</td>
          <td>${escapeHtml(p.cliente?.endereco||"-")}</td>
          <td>${escapeHtml(itens)}</td>
          <td>R$ ${moeda(p.total)}</td>
          <td>${p.pix?"PIX":"Outro"}</td>
          <td>
            <select onchange="atualizarStatus('${escapeAttr(id)}', this.value)">
              <option ${p.status==="Pendente"?"selected":""}>Pendente</option>
              <option ${p.status==="Preparando"?"selected":""}>Preparando</option>
              <option ${p.status==="Saiu para entrega"?"selected":""}>Saiu para entrega</option>
              <option ${p.status==="Conclu√≠do"?"selected":""}>Conclu√≠do</option>
            </select>
          </td>
          <td><button class="btn-remover" onclick="removerPedido('${escapeAttr(id)}')">Excluir</button></td>`;
        tbody.appendChild(tr);
      });

      atualizarAutoSoma(pedidos);
    }

    async function atualizarStatus(id, status){
      id = String(id);
      await afetch(`${API.pedidos}/${encodeURIComponent(id)}/status`, {
        method:"PUT",
        body: JSON.stringify({ status })
      });
      carregarPedidos();
    }
    async function removerPedido(id){
      id = String(id);
      if(confirm("Excluir pedido?")){
        await afetch(`${API.pedidos}/${encodeURIComponent(id)}`, { method:"DELETE" });
        carregarPedidos();
      }
    }

    /* ---------------- Bootstrap ---------------- */
    document.addEventListener("DOMContentLoaded", ()=>{
      registrarServiceWorker();
      carregarProdutos();
      carregarPedidos();
      setInterval(carregarPedidos, 5000);

      document.getElementById("listaProdutos").addEventListener("dblclick", (e)=>{
        const tr = e.target.closest("tr[data-id]");
        if (tr) editarProduto(String(tr.dataset.id));
      });
    });
  </script>
</body>
</html>
