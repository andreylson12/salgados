<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel ‚Äì Salgados da Rayleniza</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA / tema -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#0b0f1a" />

  <style>
    :root{
      /* Paleta ‚Äúsalgados‚Äù ‚Äì quente e apetitosa */
      --bg:#0b0f1a;          /* fundo geral bem escuro */
      --bg-soft:#121826;     /* pain√©is */
      --text:#eef2ff;        /* texto principal */
      --muted:#94a3b8;       /* texto fraco */
      --brand:#ea580c;       /* laranja/√¢mbar */
      --brand-2:#f59e0b;     /* √¢mbar claro */
      --ok:#22c55e;          /* verde confirmar */
      --ok-2:#16a34a;
      --err:#ef4444;         /* vermelho erro */
      --blue:#3b82f6;        /* azul a√ß√£o */
      --soft:#1f2937;        /* bordas */
      --card:#0f172a;        /* tr alternada */
      --shadow:0 8px 24px rgba(0,0,0,.25);
      --radius:14px;
    }

    *{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    body{
      margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display:flex; min-height:100vh; background:linear-gradient(160deg, #0b0f1a 0%, #0f172a 60%, #111827 100%); color:var(--text);
    }

    /* ===== Sidebar ===== */
    .sidebar{
      width:260px; background:linear-gradient(180deg,#0f172a 0%, #0b0f1a 100%);
      padding:22px; position:sticky; top:0; align-self:flex-start; height:100vh; box-shadow:var(--shadow);
      border-right:1px solid #0b1220;
    }
    .brand{
      display:flex; align-items:center; gap:10px; margin-bottom:18px;
    }
    .logo{
      width:42px; height:42px; border-radius:12px; background:radial-gradient(circle at 30% 30%, #f97316, #ea580c 60%, #9a3412);
      display:grid; place-items:center; color:#fff; font-weight:800; box-shadow:0 6px 20px rgba(234,88,12,.45);
    }
    .brand h2{ margin:0; line-height:1.1; font-size:18px }
    .brand small{ color:var(--muted); display:block; margin-top:2px }

    .nav{
      margin-top:16px; display:grid; gap:10px;
    }
    .nav a{
      display:flex; align-items:center; gap:10px;
      padding:12px 14px; border-radius:12px; text-decoration:none; color:var(--text);
      background:rgba(255,255,255,.02); border:1px solid #0b1220; transition:.2s;
    }
    .nav a:hover{ transform:translateY(-1px); border-color:#12203a; background:rgba(255,255,255,.04) }
    .nav a .icon{ width:28px; height:28px; border-radius:8px; background:#121826; display:grid; place-items:center; color:#ffd09b }

    /* ===== Conte√∫do ===== */
    .content{
      flex:1; padding:28px; overflow-y:auto; max-width:1200px; margin:0 auto;
    }
    .page-head{
      display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:18px;
    }
    .page-head h1{ margin:0; font-size:22px }
    .chip{
      background:linear-gradient(90deg, #1f2937 0%, #0b1220 100%);
      border:1px solid #0b1220; color:var(--muted); padding:8px 12px; border-radius:999px; font-size:13px;
    }

    .section{
      background:linear-gradient(180deg, #0b1220 0%, #0f172a 100%);
      border:1px solid #0b1220; border-radius:var(--radius);
      padding:18px; margin-bottom:18px; box-shadow:var(--shadow);
      display:none;
    }
    .section.active{ display:block }

    /* ===== Form & Table ===== */
    form input, form button, form select{
      padding:10px 12px; border-radius:12px; border:1px solid #101827; background:#0b1220; color:var(--text);
      box-shadow:inset 0 0 0 1px #0b1220;
    }
    form input::placeholder{ color:#94a3b84d }
    form button{ background:linear-gradient(180deg, var(--brand) 0%, #c2410c 100%); border:none; color:#fff; cursor:pointer; font-weight:600 }
    form button:hover{ filter:brightness(.98) }

    input[type="number"]{ width:140px }
    input[type="url"], input[type="text"]{ width:100%; max-width:420px }

    table{ border-collapse:separate; border-spacing:0; width:100%; background:#0b1220; border:1px solid #0b1220; border-radius:12px; overflow:hidden }
    thead th{
      background:linear-gradient(180deg,#0e1a2c 0%,#0b1220 100%); color:#cbd5e1; text-transform:uppercase; letter-spacing:.02em;
      font-size:12px; padding:12px 10px; border-bottom:1px solid #0e1a2c;
    }
    td{ padding:12px 10px; border-bottom:1px solid #0e1a2c; vertical-align:top; text-align:center; color:#e2e8f0 }
    tr:nth-child(2n) td{ background:#0d1728 }
    tr.editing td{ background:#0f2036 }

    .acao-grid{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap }
    button.action{ padding:8px 10px; border-radius:10px; color:#fff; border:none; cursor:pointer }
    .btn-remover{ background:linear-gradient(180deg,var(--err),#b91c1c) }
    .btn-editar{ background:linear-gradient(180deg,var(--blue),#2563eb) }
    .btn-cancelar{ background:linear-gradient(180deg,#64748b,#475569) }
    .btn-salvar{ background:linear-gradient(180deg,var(--ok),var(--ok-2)) }

    .total-row td{ font-weight:700; background:#0d1728; color:#fff }

    .helper{ color:var(--muted); font-size:12px; margin-top:4px; word-break:break-all }

    /* badges */
    .badge{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      background:rgba(234,88,12,.12); color:#ffedd5; border:1px solid rgba(234,88,12,.25); font-size:12px;
    }

    @media (max-width:980px){
      .sidebar{ position:fixed; inset:0 auto 0 0; width:220px; transform:translateX(-100%); transition:.25s }
      .sidebar.open{ transform:none }
      .content{ padding:22px 16px }
    }
  </style>
</head>

<body>
  <!-- ===== Sidebar ===== -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="logo">üç©</div>
      <div>
        <h2>Salgados da Rayleniza</h2>
        <small>painel administrativo</small>
      </div>
    </div>

    <nav class="nav">
      <a onclick="mostrarSecao('produtos')"><span class="icon">üè∑Ô∏è</span> Produtos</a>
      <a onclick="mostrarSecao('pedidos')"><span class="icon">üöö</span> Pedidos</a>
    </nav>
  </aside>

  <!-- ===== Conte√∫do ===== -->
  <main class="content">
    <div class="page-head">
      <h1>Gest√£o de pedidos e card√°pio</h1>
      <span class="chip">Salgados da Rayleniza</span>
    </div>

    <!-- Produtos -->
    <section id="produtos" class="section active">
      <h2 style="margin-top:0;display:flex;align-items:center;gap:10px">
        <span class="badge">üè∑Ô∏è Produtos</span>
      </h2>

      <form id="formProdutos" style="display:flex;flex-wrap:wrap;gap:10px;align-items:flex-start;margin-bottom:14px">
        <input id="nomeProduto" placeholder="Nome do salgado" required />
        <input id="precoProduto" type="number" step="0.01" placeholder="Pre√ßo" required />
        <input id="estoqueProduto" type="number" placeholder="Estoque" required />
        <input id="imagemProduto" placeholder="URL da imagem (opcional)" />
        <button type="submit">Adicionar</button>
        <div class="helper" style="flex-basis:100%">Dica: voc√™ tamb√©m pode editar direto na tabela.</div>
      </form>

      <table>
        <thead>
          <tr>
            <th>Nome</th><th>Pre√ßo</th><th>Estoque</th><th>Imagem (URL)</th><th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="listaProdutos"></tbody>
      </table>
    </section>

    <!-- Pedidos -->
    <section id="pedidos" class="section">
      <h2 style="margin-top:0;display:flex;align-items:center;gap:10px">
        <span class="badge">üöö Pedidos</span>
      </h2>

      <table>
        <thead>
          <tr>
            <th>ID</th><th>Cliente</th><th>Endere√ßo</th><th>Itens</th>
            <th>Total</th><th>Pagamento</th><th>Status</th><th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="listaPedidos"></tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="4" style="text-align:right">Total geral:</td>
            <td id="tdTotalGeral">R$ 0,00</td>
            <td colspan="3"></td>
          </tr>
        </tfoot>
      </table>
    </section>
  </main>

  <audio id="alertSound" preload="auto"></audio>

  <script>
    const API = { produtos: "/api/produtos", pedidos: "/api/pedidos" };
    const moeda = n => Number(n).toFixed(2).replace('.', ',');

    function mostrarSecao(id){
      document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    // ---------- Service Worker + Push (opcional) ----------
    let swReg = null;
    async function registrarServiceWorker() {
      if ("serviceWorker" in navigator) {
        try { swReg = await navigator.serviceWorker.register("/service-worker.js"); }
        catch (e) { console.warn("[SW] falhou:", e); }
      }
    }
    function urlBase64ToUint8Array(base64String){
      const padding="=".repeat((4-base64String.length%4)%4);
      const base64=(base64String+padding).replace(/-/g,"+").replace(/_/g,"/");
      const rawData=atob(base64);
      return Uint8Array.from([...rawData].map(c=>c.charCodeAt(0)));
    }
    async function inscreverPush(){
      if(!("serviceWorker" in navigator) || !("PushManager" in window)) return;
      try{
        const keyRes=await fetch("/api/push/public-key");
        if(!keyRes.ok) return;
        const { publicKey }=await keyRes.json();
        if(!publicKey) return;
        const perm=await Notification.requestPermission();
        if(perm!=="granted") return;
        const reg=swReg || (await navigator.serviceWorker.ready);
        const sub=await reg.pushManager.subscribe({
          userVisibleOnly:true,
          applicationServerKey:urlBase64ToUint8Array(publicKey)
        });
        await fetch("/api/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(sub)});
      }catch(_){}
    }
    function notificarBanner(p){
      if(!("Notification" in window) || Notification.permission!=="granted") return;
      if(swReg && swReg.showNotification){
        swReg.showNotification("Novo pedido!",{
          body:`#${p.id} ¬∑ ${p.cliente?.nome || "Cliente"} ¬∑ R$ ${moeda(p.total)}`,
          tag:`pedido-${p.id}`, vibrate:[100,50,100],
          icon:"/icons/icon-192.png", badge:"/icons/icon-192.png"
        });
      }else{
        new Notification("Novo pedido!",{ body:`#${p.id} ¬∑ ${p.cliente?.nome || "Cliente"} ¬∑ R$ ${moeda(p.total)}`, tag:`pedido-${p.id}` });
      }
    }

    // ---------- Produtos (edi√ß√£o inline) ----------
    const estadoEdicao = new Map();

    async function carregarProdutos(){
      const res = await fetch(API.produtos,{cache:"no-store"});
      if(!res.ok){ alert("Falha ao carregar produtos."); return;}
      const produtos = await res.json();
      const tbody = document.getElementById("listaProdutos");
      tbody.innerHTML="";
      produtos.forEach(p=>{
        const tr=document.createElement("tr");
        const id = String(p.id);
        tr.dataset.id=id;
        tr.innerHTML = renderLinhaProdutoView({ ...p, id });
        tbody.appendChild(tr);
      });
    }

    function renderLinhaProdutoView(p){
      const img = p.imagem || "https://via.placeholder.com/300x300?text=Produto";
      const idAttr = escapeAttr(String(p.id));
      return `
        <td title="${escapeAttr(p.nome)}">${escapeHtml(p.nome)}</td>
        <td>R$ ${moeda(p.preco)}</td>
        <td>${Number(p.estoque)}</td>
        <td><div class="helper">${escapeHtml(img)}</div></td>
        <td>
          <div class="acao-grid">
            <button class="action btn-editar" onclick="editarProduto('${idAttr}')">Editar</button>
            <button class="action btn-remover" onclick="removerProduto('${idAttr}')">Excluir</button>
          </div>
        </td>
      `;
    }

    function renderLinhaProdutoEdit(p){
      const id = String(p.id);
      const valores = estadoEdicao.get(id) || { nome:p.nome, preco:p.preco, estoque:p.estoque, imagem:p.imagem || "" };
      const idAttr = escapeAttr(id);
      return `
        <td><input type="text" id="edit-nome-${idAttr}" value="${escapeAttr(valores.nome)}" placeholder="Nome" /></td>
        <td><input type="number" id="edit-preco-${idAttr}" value="${Number(valores.preco)}" step="0.01" min="0" placeholder="Pre√ßo" /></td>
        <td><input type="number" id="edit-estoque-${idAttr}" value="${parseInt(valores.estoque||0)}" min="0" placeholder="Estoque" /></td>
        <td>
          <input type="url" id="edit-imagem-${idAttr}" value="${escapeAttr(valores.imagem || "")}" placeholder="URL da imagem" />
          <div class="helper">Dica: deixe vazio para manter a atual.</div>
        </td>
        <td>
          <div class="acao-grid">
            <button class="action btn-salvar" onclick="salvarProduto()">Salvar</button>
            <button class="action btn-cancelar" onclick="cancelarEdicao('${idAttr}')">Cancelar</button>
          </div>
        </td>
      `;
    }

    function editarProduto(id){
      id=String(id);
      const tr=document.querySelector(`tr[data-id="${CSS.escape(id)}"]`);
      if(!tr || tr.classList.contains("editing")) return;
      const tds=tr.querySelectorAll("td");
      const atual={
        nome: tds[0].innerText.trim(),
        preco: parseFloat((tds[1].innerText || "0").replace(/[^\d,.-]/g,"").replace(".","").replace(",", ".")) || 0,
        estoque: parseInt(tds[2].innerText) || 0,
        imagem: (tds[3].querySelector(".helper")?.textContent || "").trim()
      };
      estadoEdicao.set(id,{...atual,original:atual});
      tr.classList.add("editing");
      tr.innerHTML=renderLinhaProdutoEdit({id,...atual});
      tr.querySelectorAll("input").forEach(inp=>{
        inp.addEventListener("keydown",e=>{
          if(e.key==="Enter") salvarProduto();
          if(e.key==="Escape") cancelarEdicao(id);
        });
      });
      tr.querySelector(`#edit-nome-${CSS.escape(id)}`)?.focus();
    }

    function cancelarEdicao(id){
      id=String(id);
      const tr=document.querySelector(`tr[data-id="${CSS.escape(id)}"]`);
      if(!tr) return;
      const st=estadoEdicao.get(id);
      const p=st?.original?{id,...st.original}:{id,nome:"-",preco:0,estoque:0,imagem:""};
      tr.classList.remove("editing");
      tr.innerHTML=renderLinhaProdutoView(p);
      estadoEdicao.delete(id);
    }

    async function salvarProduto(){
      const tr=document.querySelector("tr.editing");
      if(!tr) return;
      const id=String(tr.dataset.id);
      const nome=(document.getElementById(`edit-nome-${id}`)?.value||"").trim();
      const preco=parseFloat(document.getElementById(`edit-preco-${id}`)?.value||"0");
      const estoque=parseInt(document.getElementById(`edit-estoque-${id}`)?.value||"0");
      const imagem=(document.getElementById(`edit-imagem-${id}`)?.value||"").trim();
      if(!nome) return alert("Informe o nome.");
      if(Number.isNaN(preco)||preco<0) return alert("Pre√ßo inv√°lido.");
      if(!Number.isInteger(estoque)||estoque<0) return alert("Estoque inv√°lido.");
      const payload={nome,preco,estoque}; if(imagem) payload.imagem=imagem;

      try{
        let res=await fetch(`${API.produtos}/${encodeURIComponent(id)}`,{
          method:"PATCH", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)
        });
        if(!res.ok){
          res=await fetch(`${API.produtos}/${encodeURIComponent(id)}`,{
            method:"PUT", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)
          });
        }
        if(!res.ok){ throw new Error("Falha ao atualizar produto"); }
        await carregarProdutos();
      }catch(e){ console.error(e); alert("Erro ao salvar."); }
      finally{ estadoEdicao.delete(id); }
    }

    function escapeHtml(str){ return String(str).replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }
    function escapeAttr(str){ return escapeHtml(str).replace(/"/g,"&quot;"); }

    async function removerProduto(id){
      id=String(id);
      if(confirm("Excluir?")){
        await fetch(`${API.produtos}/${encodeURIComponent(id)}`,{method:"DELETE"});
        carregarProdutos();
      }
    }

    // ---------- Pedidos ----------
    function atualizarAutoSoma(pedidos){
      const total=(Array.isArray(pedidos)?pedidos:[]).reduce((s,p)=>s+Number(p.total||0),0);
      const td=document.getElementById('tdTotalGeral'); if(td) td.textContent='R$ '+moeda(total);
    }

    let pedidosConhecidos=new Set();
    async function carregarPedidos(){
      const res=await fetch(API.pedidos,{cache:"no-store"});
      if(!res.ok) return;
      const pedidos=await res.json();
      const tbody=document.getElementById("listaPedidos"); tbody.innerHTML="";
      pedidos.forEach(p=>{ if(!pedidosConhecidos.has(p.id)){ if(pedidosConhecidos.size>0) notificarBanner(p); pedidosConhecidos.add(p.id);} });
      pedidos.forEach(p=>{
        const id=String(p.id);
        const itens=(p.itens||[]).map(i=>`${i.nome} x${i.quantidade}`).join(", ");
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${escapeHtml(id)}</td>
          <td>${escapeHtml(p.cliente?.nome||"-")}</td>
          <td>${escapeHtml(p.cliente?.endereco||"-")}</td>
          <td>${escapeHtml(itens)}</td>
          <td>R$ ${moeda(p.total)}</td>
          <td>${p.pix?"PIX":"Outro"}</td>
          <td>
            <select onchange="atualizarStatus('${escapeAttr(id)}', this.value)" style="background:#0b1220;color:#fff;border:1px solid #101827;border-radius:10px;padding:8px">
              <option ${p.status==="Pendente"?"selected":""}>Pendente</option>
              <option ${p.status==="Preparando"?"selected":""}>Preparando</option>
              <option ${p.status==="Saiu para entrega"?"selected":""}>Saiu para entrega</option>
              <option ${p.status==="Conclu√≠do"?"selected":""}>Conclu√≠do</option>
            </select>
          </td>
          <td><button class="action btn-remover" onclick="removerPedido('${escapeAttr(id)}')">Excluir</button></td>`;
        tbody.appendChild(tr);
      });
      atualizarAutoSoma(pedidos);
    }

    async function atualizarStatus(id,status){
      id=String(id);
      await fetch(`${API.pedidos}/${encodeURIComponent(id)}/status`,{
        method:"PUT", headers:{"Content-Type":"application/json"}, body:JSON.stringify({status})
      });
      carregarPedidos();
    }
    async function removerPedido(id){
      id=String(id);
      if(confirm("Excluir pedido?")){
        await fetch(`${API.pedidos}/${encodeURIComponent(id)}`,{method:"DELETE"});
        carregarPedidos();
      }
    }

    // ---------- Bootstrap ----------
    document.addEventListener("DOMContentLoaded", ()=>{
      registrarServiceWorker().then(inscreverPush);
      carregarProdutos();
      carregarPedidos();
      setInterval(carregarPedidos, 5000);

      document.getElementById("listaProdutos").addEventListener("dblclick",(e)=>{
        const tr=e.target.closest("tr[data-id]"); if(tr) editarProduto(String(tr.dataset.id));
      });
    });
  </script>
</body>
</html>
